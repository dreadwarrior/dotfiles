#!/bin/sh
#
# -*- Mode: sh; coding: utf-8; indent-tabs-mode: nil; tab-width: 2 -*-
# vim:set expandtab tabstop=2 fenc=utf-8 fileformat=unix filetype=sh:
#
# Installs docker engine, compose and machine
#
# NOTE: Currently only Debian Linux is supported
# TODO: - add uninstall option
#       - fix DIST_CODENAME usage in sudo HEREDOC

DIST="`uname -a`"
DIST_CODENAME="debian-jessie"
PLATFORM="`uname -s`-`uname -m`"
COMPOSE_VERSION="1.6.2"
MACHINE_VERSION="v0.8.0-rc1"

# @see https://docs.docker.com/engine/installation/linux/debian/

if test "${DIST#*'Debian'}" != "${DIST}"; then
  echo "Docker installation is currently only supported on Debian Linux."
  exit 1
fi

sudo -i <<'EOF'
  echo "==> Cleaning up..."
  apt-get purge lxc-docker*
  apt-get purge docker.io*

  echo "==> Update package information, ensure that APT works with the https method, and that CA certificates are installed."
  apt-get update
  apt-get -y install apt-transport-https ca-certificates

  echo "==> Add the new GPG key."
  apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D

  echo "==> Add sources.list.d file for docker."
  #echo "deb https://apt.dockerproject.org/repo ${DIST_CODENAME} main" > /etc/apt/sources.list.d/docker.list

  echo "==> Update package cache, install docker-engine and start the docker service."
  apt-get update
  apt-get -y install docker-engine
  service docker start
EOF

echo "==> Installing docker-compose..."

curl -L https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-${PLATFORM} > ~/.local/bin/docker-compose
chmod u+x ~/.local/bin/docker-compose

echo "==> Installing docker-machine..."

curl -L https://github.com/docker/machine/releases/download/${MACHINE_VERSION}/docker-machine-${PLATFORM} > ~/.local/bin/docker-machine
chmod u+x ~/.local/bin/docker-machine
